# 阅心 — 一鍵部署：推送到 main 或手動觸發時，自動部署後端到 Railway、前端到 Vercel
# 首次使用前請先完成「一鍵部署一次性設定」：docs/DEPLOYMENT_ONE_CLICK_SETUP.md

name: Deploy 阅心

on:
  push:
    branches: [main]
  workflow_dispatch:   # 允許在 GitHub Actions 頁面手動點「Run workflow」觸發

env:
  NODE_VERSION: "20"

jobs:
  deploy-backend:
    name: 部署後端 (Railway)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 部署到 Railway
        working-directory: backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up --detach

  deploy-frontend:
    name: 部署前端 (Vercel)
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: 連結 Vercel 專案並拉取設定
        working-directory: frontend
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm install -g vercel@latest
          mkdir -p .vercel && echo "{\"orgId\":\"$VERCEL_ORG_ID\",\"projectId\":\"$VERCEL_PROJECT_ID\"}" > .vercel/project.json
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN

      - name: 建置並部署前端
        working-directory: frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          vercel build --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
